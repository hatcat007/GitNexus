---
phase: 01-foundation-security
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - gitnexus-mcp/src/mcp/server.ts
autonomous: true

must_haves:
  truths:
    - "Health check resource returns connection status and graph availability"
    - "Graceful shutdown waits for pending requests before exit"
    - "Transport instances are isolated per session (stdio spawns fresh process per agent)"
  artifacts:
    - path: "gitnexus-mcp/src/mcp/server.ts"
      provides: "Health check resource, graceful shutdown, security documentation"
      contains: ["gracefulShutdown", "gitnexus://codebase/health", "CVE-2026-25536"]
  key_links:
    - from: "server.ts ReadResourceRequestSchema"
      to: "health check"
      via: "gitnexus://codebase/health URI"
    - from: "server.ts process.on(SIGINT/SIGTERM)"
      to: "gracefulShutdown()"
      via: "signal handler"
---

<objective>
Add health check resource, enhance graceful shutdown, and document transport isolation security.

Purpose: Provide observability into server health, ensure clean shutdown, and document security considerations for CVE-2026-25536.
Output: Updated server.ts with health resource, graceful shutdown, and security documentation
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add health check resource</name>
  <files>gitnexus-mcp/src/mcp/server.ts</files>
  <action>
In `gitnexus-mcp/src/mcp/server.ts`:

1. In ListResourcesRequestSchema handler (around line 119-136):
   - Add health resource to the resources array:
   ```typescript
   {
     uri: 'gitnexus://codebase/health',
     name: 'GitNexus Health',
     description: 'Connection status and graph availability',
     mimeType: 'application/json',
   }
   ```

2. In ReadResourceRequestSchema handler (around line 139-169):
   - Add handler for 'gitnexus://codebase/health' URI:
   ```typescript
   if (uri === 'gitnexus://codebase/health') {
     const context = client.context;
     const health = {
       status: client.isConnected ? (context ? 'healthy' : 'no_context') : 'disconnected',
       timestamp: new Date().toISOString(),
       connection: {
         browser: client.isConnected,
         mode: /* 'hub' or 'peer' - need to expose from WebSocketBridge */,
       },
       context: context ? {
         project: context.projectName,
         files: context.stats.fileCount,
         functions: context.stats.functionCount,
       } : null,
     };
     return {
       contents: [{ uri, mimeType: 'application/json', text: JSON.stringify(health, null, 2) }],
     };
   }
   ```

Note: WebSocketBridge needs a public `isHub` getter or similar to expose mode. Add if not present.
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Health check resource returns JSON with status, timestamp, connection info</done>
</task>

<task type="auto">
  <name>Task 2: Enhance graceful shutdown with logging</name>
  <files>gitnexus-mcp/src/mcp/server.ts</files>
  <action>
In `gitnexus-mcp/src/mcp/server.ts`:

Replace the existing SIGINT/SIGTERM handlers (lines 215-225) with enhanced version:

```typescript
let isShuttingDown = false;

async function gracefulShutdown(signal: string) {
  if (isShuttingDown) return;
  isShuttingDown = true;
  
  logger.info({ signal }, 'Starting graceful shutdown');
  
  // 1. Stop accepting new requests
  try {
    await server.close();
    logger.info('MCP server closed');
  } catch (e) {
    logger.error({ error: e }, 'Error closing MCP server');
  }
  
  // 2. Wait briefly for pending requests (WebSocketBridge tracks these)
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  // 3. Close WebSocket connections
  client.disconnect?.();
  logger.info('WebSocket disconnected');
  
  logger.info('Graceful shutdown complete');
  process.exit(0);
}

process.on('SIGINT', () => gracefulShutdown('SIGINT'));
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));

// Handle uncaught exceptions
process.on('uncaughtException', (error) => {
  logger.error({ error }, 'Uncaught exception');
  gracefulShutdown('uncaughtException');
});

process.on('unhandledRejection', (reason, promise) => {
  logger.error({ reason }, 'Unhandled rejection');
});
```
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Graceful shutdown logs progress, waits for pending requests, handles exceptions</done>
</task>

<task type="auto">
  <name>Task 3: Add transport isolation documentation (SECU-03)</name>
  <files>gitnexus-mcp/src/mcp/server.ts</files>
  <action>
Add JSDoc comment to `startMCPServer` function (around line 104):

```typescript
/**
 * Start the MCP server on stdio transport.
 * 
 * SECURITY NOTE (CVE-2026-25536):
 * This implementation is safe for stdio transport because each AI agent
 * spawns a fresh MCP process. Server and transport instances are never
 * reused across clients - each process invocation gets its own isolated
 * Server and Transport instances.
 * 
 * If migrating to HTTP transport in the future, ensure fresh Server and
 * Transport instances are created per session to prevent cross-client
 * data leakage.
 */
```

This addresses SECU-03: The current stdio implementation is inherently safe.
No code changes needed - only documentation to warn future maintainers.
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Security documentation added for transport isolation (CVE-2026-25536)</done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- Health check resource accessible at gitnexus://codebase/health
- Graceful shutdown handles signals and exceptions with logging
- JSDoc documents transport isolation security considerations
</verification>

<success_criteria>
- Health check returns connection status
- Graceful shutdown completes cleanly with logging
- CVE-2026-25536 documented for future maintainers
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-03-SUMMARY.md`
</output>
