---
phase: 01-foundation-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gitnexus-mcp/src/mcp/logger.ts
  - gitnexus-mcp/src/mcp/errors.ts
  - gitnexus-mcp/src/mcp/schemas.ts
  - gitnexus-mcp/src/mcp/cypher-sanitizer.ts
  - gitnexus-mcp/package.json
autonomous: true

must_haves:
  truths:
    - "Logger produces structured JSON output with request context"
    - "Error responses include code, message, and actionable suggestion"
    - "All tool inputs validated against Zod schemas before processing"
    - "Cypher queries rejected if containing destructive keywords"
  artifacts:
    - path: "gitnexus-mcp/src/mcp/logger.ts"
      provides: "pino structured logging"
      min_lines: 20
    - path: "gitnexus-mcp/src/mcp/errors.ts"
      provides: "Error types and formatting"
      exports: ["formatError", "ErrorCodes", "GitNexusError"]
    - path: "gitnexus-mcp/src/mcp/schemas.ts"
      provides: "Zod schemas for all 9 tools"
      exports: ["validateToolInput", "toolSchemas"]
    - path: "gitnexus-mcp/src/mcp/cypher-sanitizer.ts"
      provides: "Cypher query validation"
      exports: ["sanitizeCypher"]
  key_links:
    - from: "gitnexus-mcp/src/mcp/schemas.ts"
      to: "gitnexus-mcp/src/mcp/errors.ts"
      via: "ValidationError on failed parse"
      pattern: "formatError.*VALIDATION_ERROR"
---

<objective>
Create foundation modules for logging, error handling, input validation, and Cypher sanitization.

Purpose: These are the building blocks that the server will consume. They must be complete before integration.
Output: Four new TypeScript modules + updated package.json with dependencies
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dependencies and create logger module</name>
  <files>gitnexus-mcp/package.json, gitnexus-mcp/src/mcp/logger.ts</files>
  <action>
Add to package.json dependencies:
```json
"zod": "^3.23.0",
"zod-to-json-schema": "^3.23.0",
"pino": "^9.0.0",
"pino-pretty": "^11.0.0"
```

Create `gitnexus-mcp/src/mcp/logger.ts`:
- Import pino
- Export logger instance with level from LOG_LEVEL env var (default 'info')
- Configure pino-pretty transport for development (colorize: true)
- Export `createRequestLogger(requestId: string, toolName?: string)` that returns child logger with requestId, tool, and agent context
- Agent name from `process.env.GITNEXUS_AGENT || 'unknown'`
</action>
  <verify>`cd gitnexus-mcp && npm install && npx tsc --noEmit` passes</verify>
  <done>Logger module exports pino instance and createRequestLogger function</done>
</task>

<task type="auto">
  <name>Task 2: Create structured error handling module</name>
  <files>gitnexus-mcp/src/mcp/errors.ts</files>
  <action>
Create `gitnexus-mcp/src/mcp/errors.ts`:

```typescript
// GitNexusError interface with: code, message, details?, suggestion?
// ErrorCodes constant object with: VALIDATION_ERROR, TOOL_NOT_FOUND, BROWSER_DISCONNECTED, QUERY_TIMEOUT, CYPHER_FORBIDDEN, INTERNAL_ERROR
// formatError(error: GitNexusError): CallToolResult - returns MCP format with isError: true and JSON content
// Content should be JSON stringified with {error: true, code, message, details, suggestion}
```

Import CallToolResult type from '@modelcontextprotocol/sdk/types.js'
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Error module exports GitNexusError interface, ErrorCodes, and formatError function</done>
</task>

<task type="auto">
  <name>Task 3: Create Zod schemas for all tools</name>
  <files>gitnexus-mcp/src/mcp/schemas.ts</files>
  <action>
Create `gitnexus-mcp/src/mcp/schemas.ts`:

Define Zod schemas for all 9 tools (see tools.ts for current inputSchema definitions):
- ContextSchema: empty object
- SearchSchema: query (string min 1), limit (number int 1-100 default 10), groupByProcess (boolean default true)
- CypherSchema: query (string min 1)
- GrepSchema: pattern (string min 1), caseSensitive (boolean default false), maxResults (number int 1-500 default 50)
- ReadSchema: filePath (string min 1), startLine (number int min 1 optional), endLine (number int min 1 optional)
- ExploreSchema: name (string min 1), type (enum: 'symbol' | 'cluster' | 'process')
- OverviewSchema: showProcesses (boolean default true), showClusters (boolean default true), limit (number int 1-100 default 20)
- ImpactSchema: target (string min 1), direction (enum: 'upstream' | 'downstream'), maxDepth (number int 1-10 default 3), relationTypes (array of strings optional), includeTests (boolean default false), minConfidence (number 0-1 default 0.7)
- HighlightSchema: nodeIds (array of strings min 1), color (string optional)

Export `toolSchemas` object mapping tool name to zodToJsonSchema output.
Export `validateToolInput(toolName: string, input: unknown)` returning schema.safeParse result.
Use zod-to-json-schema to convert schemas.
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Schemas module exports all 9 Zod schemas, toolSchemas object, and validateToolInput function</done>
</task>

<task type="auto">
  <name>Task 4: Create Cypher query sanitizer</name>
  <files>gitnexus-mcp/src/mcp/cypher-sanitizer.ts</files>
  <action>
Create `gitnexus-mcp/src/mcp/cypher-sanitizer.ts`:

```typescript
const ALLOWED_CLAUSES = ['MATCH', 'RETURN', 'WHERE', 'WITH', 'ORDER', 'BY', 'LIMIT', 'SKIP', 'AS', 'OPTIONAL', 'CASE', 'WHEN', 'THEN', 'ELSE', 'END', 'DISTINCT', 'COUNT', 'SUM', 'AVG', 'MIN', 'MAX', 'COLLECT', 'SIZE', 'HEAD', 'LAST', 'TYPE', 'LABELS', 'ID', 'COALESCE', 'NULL'];
const FORBIDDEN_KEYWORDS = ['CREATE', 'MERGE', 'DELETE', 'DETACH', 'DROP', 'SET', 'REMOVE', 'CALL', 'LOAD', 'CSV', 'FOREACH'];

interface SanitizationResult { valid: boolean; error?: string; query?: string; }

export function sanitizeCypher(query: string): SanitizationResult
```

Implementation:
1. Convert query to uppercase for checking
2. Check for forbidden keywords using word boundary regex (\bKEYWORD\b)
3. Check that query starts with allowed clause (first word)
4. Return { valid: false, error: "message" } on failure, { valid: true, query } on success
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Sanitizer module exports sanitizeCypher function that rejects destructive Cypher operations</done>
</task>

</tasks>

<verification>
- All 4 new TypeScript files compile without errors
- package.json has 4 new dependencies
- npm install succeeds
- TypeScript build succeeds
</verification>

<success_criteria>
- Logger module provides structured JSON logging with request context
- Error module provides typed errors with actionable suggestions
- Schemas module validates all 9 tool inputs with Zod
- Sanitizer module blocks destructive Cypher operations
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-01-SUMMARY.md`
</output>
