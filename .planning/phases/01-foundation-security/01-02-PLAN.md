---
phase: 01-foundation-security
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - gitnexus-mcp/src/mcp/server.ts
  - gitnexus-mcp/src/mcp/tools.ts
autonomous: true

must_haves:
  truths:
    - "Tool calls return structured JSON errors with actionable context when failing"
    - "Invalid inputs are rejected with validation error before processing"
    - "Cypher queries with forbidden keywords return CYPHER_FORBIDDEN error"
    - "Server logs all operations with structured JSON output"
    - "Health check resource returns connection status and graph availability"
    - "Graceful shutdown waits for pending requests before exit"
  artifacts:
    - path: "gitnexus-mcp/src/mcp/server.ts"
      provides: "Integrated MCP server with validation, logging, health check"
      contains: ["formatError", "sanitizeCypher", "validateToolInput", "createRequestLogger"]
    - path: "gitnexus-mcp/src/mcp/tools.ts"
      provides: "Tool definitions with Zod-derived schemas"
      pattern: "zodToJsonSchema"
  key_links:
    - from: "server.ts CallToolRequestSchema"
      to: "schemas.ts"
      via: "validateToolInput before processing"
    - from: "server.ts cypher tool"
      to: "cypher-sanitizer.ts"
      via: "sanitizeCypher before forwarding"
    - from: "server.ts ReadResourceRequestSchema"
      to: "health check"
      via: "gitnexus://codebase/health URI"
---

<objective>
Integrate foundation modules into MCP server, add health check resource, and enhance graceful shutdown.

Purpose: Wire all the foundation modules together so the server validates inputs, logs operations, returns structured errors, and provides health status.
Output: Updated server.ts with full integration, updated tools.ts with Zod schemas
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update tools.ts to use Zod-derived schemas</name>
  <files>gitnexus-mcp/src/mcp/tools.ts</files>
  <action>
Import `toolSchemas` from './schemas.js'

Replace each tool's `inputSchema` object with the corresponding entry from toolSchemas:
- context -> toolSchemas.context
- search -> toolSchemas.search
- cypher -> toolSchemas.cypher
- grep -> toolSchemas.grep
- read -> toolSchemas.read
- explore -> toolSchemas.explore
- overview -> toolSchemas.overview
- impact -> toolSchemas.impact
- highlight -> toolSchemas.highlight

Keep all descriptions unchanged.
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Tool definitions use Zod-derived JSON schemas</done>
</task>

<task type="auto">
  <name>Task 2: Integrate validation, logging, and errors in server.ts</name>
  <files>gitnexus-mcp/src/mcp/server.ts</files>
  <action>
Update `gitnexus-mcp/src/mcp/server.ts`:

1. Add imports:
```typescript
import { logger, createRequestLogger } from './logger.js';
import { formatError, ErrorCodes, type GitNexusError } from './errors.js';
import { validateToolInput } from './schemas.js';
import { sanitizeCypher } from './cypher-sanitizer.js';
```

2. In CallToolRequestSchema handler (around line 181-208):
   - Generate requestId: `req_${Date.now()}`
   - Create child logger: `const log = createRequestLogger(requestId, name)`
   - Log tool call start: `log.info({ args }, 'Tool call started')`
   - Track startTime for duration logging
   
   - Before calling `client.callTool(name, args)`:
     - Call `validateToolInput(name, args)`
     - If validation fails, return formatError with VALIDATION_ERROR code and the Zod error details
     - If tool is 'cypher', call `sanitizeCypher(args.query)`
     - If sanitization fails, return formatError with CYPHER_FORBIDDEN error
   
   - In catch block, use formatError with INTERNAL_ERROR code
   - Log completion: `log.info({ duration: Date.now() - startTime }, 'Tool call completed')`
   - Log errors: `log.error({ error, duration }, 'Tool call failed')`
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Server validates inputs, logs operations, returns structured errors</done>
</task>

<task type="auto">
  <name>Task 3: Add health check resource</name>
  <files>gitnexus-mcp/src/mcp/server.ts</files>
  <action>
In `gitnexus-mcp/src/mcp/server.ts`:

1. In ListResourcesRequestSchema handler (around line 119-136):
   - Add health resource to the resources array:
   ```typescript
   {
     uri: 'gitnexus://codebase/health',
     name: 'GitNexus Health',
     description: 'Connection status and graph availability',
     mimeType: 'application/json',
   }
   ```

2. In ReadResourceRequestSchema handler (around line 139-169):
   - Add handler for 'gitnexus://codebase/health' URI:
   ```typescript
   if (uri === 'gitnexus://codebase/health') {
     const context = client.context;
     const health = {
       status: client.isConnected ? (context ? 'healthy' : 'no_context') : 'disconnected',
       timestamp: new Date().toISOString(),
       connection: {
         browser: client.isConnected,
         mode: /* 'hub' or 'peer' - need to expose from WebSocketBridge */,
       },
       context: context ? {
         project: context.projectName,
         files: context.stats.fileCount,
         functions: context.stats.functionCount,
       } : null,
     };
     return {
       contents: [{ uri, mimeType: 'application/json', text: JSON.stringify(health, null, 2) }],
     };
   }
   ```

Note: WebSocketBridge needs a public `isHub` getter or similar to expose mode. Add if not present.
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Health check resource returns JSON with status, timestamp, connection info</done>
</task>

<task type="auto">
  <name>Task 4: Enhance graceful shutdown with logging</name>
  <files>gitnexus-mcp/src/mcp/server.ts</files>
  <action>
In `gitnexus-mcp/src/mcp/server.ts`:

Replace the existing SIGINT/SIGTERM handlers (lines 215-225) with enhanced version:

```typescript
let isShuttingDown = false;

async function gracefulShutdown(signal: string) {
  if (isShuttingDown) return;
  isShuttingDown = true;
  
  logger.info({ signal }, 'Starting graceful shutdown');
  
  // 1. Stop accepting new requests
  try {
    await server.close();
    logger.info('MCP server closed');
  } catch (e) {
    logger.error({ error: e }, 'Error closing MCP server');
  }
  
  // 2. Wait briefly for pending requests (WebSocketBridge tracks these)
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  // 3. Close WebSocket connections
  client.disconnect?.();
  logger.info('WebSocket disconnected');
  
  logger.info('Graceful shutdown complete');
  process.exit(0);
}

process.on('SIGINT', () => gracefulShutdown('SIGINT'));
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));

// Handle uncaught exceptions
process.on('uncaughtException', (error) => {
  logger.error({ error }, 'Uncaught exception');
  gracefulShutdown('uncaughtException');
});

process.on('unhandledRejection', (reason, promise) => {
  logger.error({ reason }, 'Unhandled rejection');
});
```
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Graceful shutdown logs progress, waits for pending requests, handles exceptions</done>
</task>

<task type="auto">
  <name>Task 5: Add transport isolation documentation</name>
  <files>gitnexus-mcp/src/mcp/server.ts</files>
  <action>
Add JSDoc comment to `startMCPServer` function (around line 104):

```typescript
/**
 * Start the MCP server on stdio transport.
 * 
 * SECURITY NOTE (CVE-2026-25536):
 * This implementation is safe for stdio transport because each AI agent
 * spawns a fresh MCP process. Server and transport instances are never
 * reused across clients.
 * 
 * If migrating to HTTP transport in the future, ensure fresh Server and
 * Transport instances are created per session to prevent cross-client
 * data leakage.
 */
```
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Security documentation added for transport isolation</done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- Server imports and uses all foundation modules
- All 9 tools validated against Zod schemas
- Health check resource accessible at gitnexus://codebase/health
- Graceful shutdown handles signals and exceptions with logging
</verification>

<success_criteria>
- Tool calls return structured JSON errors with actionable context
- Invalid inputs rejected before processing with validation errors
- Destructive Cypher queries blocked
- All operations logged with structured JSON
- Health check returns connection status
- Graceful shutdown completes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-02-SUMMARY.md`
</output>
