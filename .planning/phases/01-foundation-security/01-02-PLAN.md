---
phase: 01-foundation-security
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - gitnexus-mcp/src/mcp/server.ts
  - gitnexus-mcp/src/mcp/tools.ts
autonomous: true

must_haves:
  truths:
    - "Tool calls return structured JSON errors with actionable context when failing"
    - "Invalid inputs are rejected with validation error BEFORE tool handler is called"
    - "Cypher queries with forbidden keywords return CYPHER_FORBIDDEN error"
    - "Server logs all operations with structured JSON output"
  artifacts:
    - path: "gitnexus-mcp/src/mcp/server.ts"
      provides: "MCP server with validation, logging, error handling"
      contains: ["formatError", "sanitizeCypher", "validateToolInput", "createRequestLogger"]
    - path: "gitnexus-mcp/src/mcp/tools.ts"
      provides: "Tool definitions with Zod-derived schemas"
      pattern: "zodToJsonSchema"
  key_links:
    - from: "server.ts CallToolRequestSchema"
      to: "schemas.ts"
      via: "validateToolInput() BEFORE client.callTool()"
    - from: "server.ts cypher tool handler"
      to: "cypher-sanitizer.ts"
      via: "sanitizeCypher(args.query) BEFORE executing query"
---

<objective>
Integrate foundation modules into MCP server with validation and logging.

Purpose: Wire foundation modules so the server validates inputs BEFORE processing, logs operations, and returns structured errors.
Output: Updated server.ts with validation/logging integration, updated tools.ts with Zod schemas
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update tools.ts to use Zod-derived schemas</name>
  <files>gitnexus-mcp/src/mcp/tools.ts</files>
  <action>
Import `toolSchemas` from './schemas.js'

Replace each tool's `inputSchema` object with the corresponding entry from toolSchemas:
- context -> toolSchemas.context
- search -> toolSchemas.search
- cypher -> toolSchemas.cypher
- grep -> toolSchemas.grep
- read -> toolSchemas.read
- explore -> toolSchemas.explore
- overview -> toolSchemas.overview
- impact -> toolSchemas.impact
- highlight -> toolSchemas.highlight

Keep all descriptions unchanged.
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Tool definitions use Zod-derived JSON schemas</done>
</task>

<task type="auto">
  <name>Task 2: Integrate validation, logging, and errors in server.ts</name>
  <files>gitnexus-mcp/src/mcp/server.ts</files>
  <action>
Update `gitnexus-mcp/src/mcp/server.ts`:

1. Add imports:
```typescript
import { logger, createRequestLogger } from './logger.js';
import { formatError, ErrorCodes, type GitNexusError } from './errors.js';
import { validateToolInput } from './schemas.js';
import { sanitizeCypher } from './cypher-sanitizer.js';
```

2. In CallToolRequestSchema handler (around line 181-208):
   - Generate requestId: `req_${Date.now()}`
   - Create child logger: `const log = createRequestLogger(requestId, name)`
   - Log tool call start: `log.info({ args }, 'Tool call started')`
   - Track startTime for duration logging
   
   **CRITICAL: Validation must happen BEFORE tool handler is called:**
   ```typescript
   // Step 1: Validate input against Zod schema BEFORE dispatch
   const validation = validateToolInput(name, args);
   if (!validation.success) {
     log.warn({ errors: validation.error.issues }, 'Validation failed');
     return formatError({
       code: ErrorCodes.VALIDATION_ERROR,
       message: 'Invalid input parameters',
       details: validation.error.issues,
       suggestion: 'Check parameter types and constraints'
     });
   }
   
   // Step 2: For cypher tool, sanitize query BEFORE execution
   if (name === 'cypher') {
     const sanitized = sanitizeCypher(args.query);
     if (!sanitized.valid) {
       log.warn({ query: args.query, error: sanitized.error }, 'Cypher query rejected');
       return formatError({
         code: ErrorCodes.CYPHER_FORBIDDEN,
         message: 'Forbidden Cypher operation',
         suggestion: 'Only read-only queries (MATCH, RETURN) are allowed'
       });
     }
     args.query = sanitized.query;
   }
   
   // Step 3: NOW call the tool handler
   const result = await client.callTool(name, args);
   ```
   
   - In catch block, use formatError with INTERNAL_ERROR code
   - Log completion: `log.info({ duration: Date.now() - startTime }, 'Tool call completed')`
   - Log errors: `log.error({ error, duration }, 'Tool call failed')`
</action>
  <verify>`cd gitnexus-mcp && npx tsc --noEmit` passes</verify>
  <done>Server validates inputs BEFORE tool dispatch, logs operations, returns structured errors</done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- Server imports and uses all foundation modules
- All 9 tools validated against Zod schemas BEFORE handler execution
- Cypher tool sanitizes queries BEFORE execution
</verification>

<success_criteria>
- Tool calls return structured JSON errors with actionable context
- Invalid inputs rejected BEFORE processing with validation errors
- Destructive Cypher queries blocked BEFORE execution
- All operations logged with structured JSON
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-02-SUMMARY.md`
</output>
