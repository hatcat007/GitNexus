---
phase: 02-resilience
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
  - 02-02
files_modified:
  - gitnexus-mcp/src/mcp/server.ts
autonomous: true
must_haves:
  truths:
    - "Tool calls are wrapped with configurable timeout (60s quick, 120s heavy)"
    - "Circuit breaker opens after 5 consecutive bridge failures"
    - "Circuit breaker closes immediately on successful test request"
    - "Timeout errors include tool name and duration"
    - "Circuit open errors include retry-after guidance"
  artifacts:
    - path: "gitnexus-mcp/src/mcp/server.ts"
      provides: "MCP server with resilience-wrapped tool calls"
      contains: "withToolTimeout | createCircuitBreaker | breaker.fire"
  key_links:
    - from: "server.ts CallToolRequestSchema handler"
      to: "resilience.ts"
      via: "withToolTimeout wrapper around client.callTool"
      pattern: "withToolTimeout|breaker\\.fire"
    - from: "server.ts"
      to: "errors.ts"
      via: "timeoutError, circuitOpenError imports"
      pattern: "import.*timeoutError|import.*circuitOpenError"
---

<objective>
Integrate timeout wrapper and circuit breaker into the MCP server's tool call handler.

Purpose: Wrap all tool calls with configurable timeouts and protect against cascade failures when the browser/graph is unavailable.
Output: Modified `gitnexus-mcp/src/mcp/server.ts` with resilience-wrapped tool execution
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-resilience/02-CONTEXT.md
@.planning/phases/02-resilience/02-RESEARCH.md

# Prior work
@.planning/phases/02-resilience/02-01-PLAN.md
@.planning/phases/02-resilience/02-02-PLAN.md

# Existing server implementation
@gitnexus-mcp/src/mcp/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import resilience utilities and error helpers</name>
  <files>gitnexus-mcp/src/mcp/server.ts</files>
  <action>
Add imports at the top of server.ts (after existing imports):

```typescript
import { withToolTimeout, createCircuitBreaker } from './resilience.js';
import { formatError, ErrorCodes, timeoutError, circuitOpenError } from './errors.js';
```

Update the existing formatError import line to include the new helpers if needed.
  </action>
  <verify>grep -E "import.*withToolTimeout|import.*createCircuitBreaker|import.*timeoutError|import.*circuitOpenError" gitnexus-mcp/src/mcp/server.ts</verify>
  <done>Resilience utilities and error helpers imported in server.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create circuit breaker instance in startMCPServer</name>
  <files>gitnexus-mcp/src/mcp/server.ts</files>
  <action>
Inside the `startMCPServer` function, after the `server` is created but before handlers are registered, create the circuit breaker:

```typescript
export async function startMCPServer(client: ToolCaller): Promise<void> {
  const server = new Server(
    { name: 'gitnexus', version: '0.1.0' },
    { capabilities: { tools: {}, resources: {} } }
  );

  // Create circuit breaker wrapping the client's callTool
  const breaker = createCircuitBreaker(
    (method: string, params: any) => client.callTool(method, params),
    { failureThreshold: 5, resetTimeoutMs: 30000 }
  );
  
  // Log circuit breaker state changes
  breaker.on('open', () => {
    logger.warn('Circuit breaker opened - blocking requests');
  });
  breaker.on('halfOpen', () => {
    logger.info('Circuit breaker half-open - testing with next request');
  });
  breaker.on('close', () => {
    logger.info('Circuit breaker closed - requests flowing normally');
  });

  // ... rest of handlers
}
```

The circuit breaker wraps `client.callTool` - when the breaker is open, calls will fail fast.
  </action>
  <verify>grep -E "createCircuitBreaker|breaker\\.on" gitnexus-mcp/src/mcp/server.ts | head -10</verify>
  <done>Circuit breaker instance created with 5-failure threshold and 30s reset timeout, state change logging added</done>
</task>

<task type="auto">
  <name>Task 3: Wrap tool calls with timeout and circuit breaker</name>
  <files>gitnexus-mcp/src/mcp/server.ts</files>
  <action>
In the `CallToolRequestSchema` handler, replace the direct `client.callTool` call with resilience-wrapped version:

Find the existing code (around line 271):
```typescript
// Step 3: Call the tool handler
const result = await client.callTool(name, args);
```

Replace with:
```typescript
// Step 3: Call the tool handler with resilience (timeout + circuit breaker)
// First check if circuit is open
if (breaker.opened) {
  log.warn('Circuit breaker is open');
  return formatError(circuitOpenError(30));
}

// Wrap with timeout and execute through circuit breaker
let result;
try {
  result = await withToolTimeout(name, async (signal) => {
    // Execute through circuit breaker
    return breaker.fire(name, args);
  });
} catch (error) {
  // Handle timeout specifically
  if (error instanceof Error && error.message.includes('timed out')) {
    const timeoutMs = parseInt(process.env.GITNEXUS_TIMEOUT_QUICK || '60000', 10);
    log.warn({ timeoutMs }, 'Tool call timed out');
    return formatError(timeoutError(name, timeoutMs));
  }
  // Re-throw for generic error handling below
  throw error;
}
```

The flow is: check circuit → timeout wrapper → circuit breaker → actual call.
  </action>
  <verify>grep -E "withToolTimeout|breaker\\.fire|breaker\\.opened|timeoutError|circuitOpenError" gitnexus-mcp/src/mcp/server.ts | head -15</verify>
  <done>Tool calls wrapped with both timeout (AbortController) and circuit breaker (opossum), specific error responses for timeout and circuit-open states</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds without errors
2. server.ts imports resilience utilities
3. Circuit breaker created and logs state changes
4. Tool calls go through timeout wrapper AND circuit breaker
5. Specific error responses for timeout vs circuit-open
</verification>

<success_criteria>
- Server compiles without TypeScript errors
- Tool calls are protected by both timeout and circuit breaker
- Circuit breaker opens after 5 consecutive failures
- Timeout errors include tool name and duration
- Circuit-open errors include retry guidance
</success_criteria>

<output>
After completion, create `.planning/phases/02-resilience/02-03-SUMMARY.md`
</output>
