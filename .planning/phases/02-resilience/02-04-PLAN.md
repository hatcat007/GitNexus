---
phase: 02-resilience
plan: 04
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - gitnexus-mcp/src/bridge/websocket-server.ts
autonomous: true
must_haves:
  truths:
    - "WebSocket reconnection uses exponential backoff with jitter"
    - "Backoff starts at 500ms and caps at 60 seconds"
    - "Attempt counter resets on successful connection"
    - "Reconnection attempts are logged with delay and attempt number"
    - "Hardcoded 30s timeout is replaced with configurable system"
  artifacts:
    - path: "gitnexus-mcp/src/bridge/websocket-server.ts"
      provides: "WebSocket bridge with resilient reconnection"
      contains: "calculateBackoff | ReconnectionManager | reconnect"
      min_lines: 420
  key_links:
    - from: "websocket-server.ts"
      to: "resilience.ts"
      via: "calculateBackoff import"
      pattern: "import.*calculateBackoff"
    - from: "WebSocketBridge.handleHubDisconnect"
      to: "reconnection logic"
      via: "scheduleReconnect on browser disconnect"
      pattern: "scheduleReconnect|calculateBackoff"
---

<objective>
Replace the hardcoded 30s timeout with exponential backoff reconnection in the WebSocket bridge.

Purpose: Prevent connection storms and provide resilient reconnection when the browser or hub disconnects.
Output: Modified `gitnexus-mcp/src/bridge/websocket-server.ts` with exponential backoff reconnection
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-resilience/02-CONTEXT.md
@.planning/phases/02-resilience/02-RESEARCH.md

# Prior work
@.planning/phases/02-resilience/02-01-PLAN.md

# Existing WebSocket implementation
@gitnexus-mcp/src/bridge/websocket-server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import backoff utility and add reconnection state</name>
  <files>gitnexus-mcp/src/bridge/websocket-server.ts</files>
  <action>
1. Add import at the top of websocket-server.ts:
```typescript
import { calculateBackoff } from '../mcp/resilience.js';
```

2. Add reconnection state properties to the WebSocketBridge class (in the private properties section):
```typescript
// Reconnection state
private reconnectAttempt = 0;
private reconnectTimer: NodeJS.Timeout | null = null;
private readonly maxReconnectDelay = 60000;  // 60 second cap
```

This adds the state needed for tracking reconnection attempts.
  </action>
  <verify>grep -E "import.*calculateBackoff|reconnectAttempt|reconnectTimer|maxReconnectDelay" gitnexus-mcp/src/bridge/websocket-server.ts | head -10</verify>
  <done>calculateBackoff imported, reconnection state properties added to WebSocketBridge class</done>
</task>

<task type="auto">
  <name>Task 2: Add reconnection methods to WebSocketBridge</name>
  <files>gitnexus-mcp/src/bridge/websocket-server.ts</files>
  <action>
Add reconnection helper methods to the WebSocketBridge class (in the Shared/Public API section, before `close()`):

```typescript
/**
 * Schedule a reconnection attempt with exponential backoff
 */
private scheduleReconnect(attempt: number, connectFn: () => void): void {
  const delay = calculateBackoff(attempt);
  console.error(`Reconnecting in ${delay}ms (attempt ${attempt + 1})`);
  
  this.reconnectTimer = setTimeout(() => {
    this.reconnectAttempt = attempt + 1;
    connectFn();
  }, delay);
}

/**
 * Reset reconnection state on successful connection
 */
private resetReconnectState(): void {
  this.reconnectAttempt = 0;
  if (this.reconnectTimer) {
    clearTimeout(this.reconnectTimer);
    this.reconnectTimer = null;
  }
}

/**
 * Cancel any pending reconnection
 */
private cancelReconnect(): void {
  if (this.reconnectTimer) {
    clearTimeout(this.reconnectTimer);
    this.reconnectTimer = null;
  }
}
```

These methods manage the reconnection lifecycle.
  </action>
  <verify>grep -E "scheduleReconnect|resetReconnectState|cancelReconnect" gitnexus-mcp/src/bridge/websocket-server.ts | head -10</verify>
  <done>Reconnection helper methods added: scheduleReconnect, resetReconnectState, cancelReconnect</done>
</task>

<task type="auto">
  <name>Task 3: Integrate reconnection on Hub browser disconnect</name>
  <files>gitnexus-mcp/src/bridge/websocket-server.ts</files>
  <action>
Modify the `handleHubDisconnect` method to initiate reconnection when browser disconnects.

Find the existing code:
```typescript
private handleHubDisconnect(ws: WebSocket) {
    if (ws === this.browserClient) {
        console.error('Browser disconnected from Hub');
        this.browserClient = null;
        this._context = null;
        this.notifyContextListeners();
    } else {
        // ... peer disconnect handling
    }
}
```

Update the browser disconnect branch to schedule reconnection:
```typescript
private handleHubDisconnect(ws: WebSocket) {
    if (ws === this.browserClient) {
        console.error('Browser disconnected from Hub');
        this.browserClient = null;
        this._context = null;
        this.notifyContextListeners();
        
        // Schedule reconnection with exponential backoff
        this.scheduleReconnect(this.reconnectAttempt, () => {
            // The browser needs to reconnect - we just wait
            // When it does, onContextChange will reset the counter
            console.error('Waiting for browser to reconnect...');
        });
    } else {
        const peerId = (ws as any).peerId;
        if (peerId) {
            this.peerClients.delete(peerId);
            console.error(`Peer disconnected: ${peerId}`);
        }
    }
}
```

When context arrives (browser reconnects), we reset the counter.
  </action>
  <verify>grep -A5 "Browser disconnected from Hub" gitnexus-mcp/src/bridge/websocket-server.ts | head -15</verify>
  <done>Browser disconnect triggers reconnection scheduling with exponential backoff</done>
</task>

<task type="auto">
  <name>Task 4: Reset reconnection counter on successful connection</name>
  <files>gitnexus-mcp/src/bridge/websocket-server.ts</files>
  <action>
Update `handleHubMessage` to reset the reconnection counter when browser sends context (indicating successful reconnection):

Find the context handling code:
```typescript
if (msg.type === 'context') {
    // Browser identified itself (implicitly)
    if (this.browserClient !== ws) {
        if (this.browserClient) this.browserClient.close();
        this.browserClient = ws;
        console.error('Browser connected to Hub');
    }
    
    this._context = msg.params;
    // ...
}
```

Add reconnection reset:
```typescript
if (msg.type === 'context') {
    // Browser identified itself (implicitly)
    if (this.browserClient !== ws) {
        if (this.browserClient) this.browserClient.close();
        this.browserClient = ws;
        console.error('Browser connected to Hub');
        this.resetReconnectState();  // Reset backoff on reconnection
    }
    
    this._context = msg.params;
    // ...
}
```

Also update the `close()` method to cancel pending reconnection:
```typescript
close() {
    this.cancelReconnect();
    this.wss?.close();
    this.client?.close();
}
```
  </action>
  <verify>grep -E "resetReconnectState|cancelReconnect" gitnexus-mcp/src/bridge/websocket-server.ts | head -5</verify>
  <done>Reconnection counter reset on browser reconnection, pending reconnect cancelled on close()</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds without errors
2. calculateBackoff imported from resilience module
3. Reconnection state tracked (attempt counter, timer)
4. Browser disconnect triggers exponential backoff reconnection
5. Successful browser connection resets attempt counter
6. No hardcoded 30s timeout remains (replaced with backoff system)
</verification>

<success_criteria>
- WebSocket bridge compiles without TypeScript errors
- Exponential backoff used for reconnection (500ms â†’ 60s cap)
- Attempt counter resets on successful connection
- Reconnection attempts logged with delay and attempt number
</success_criteria>

<output>
After completion, create `.planning/phases/02-resilience/02-04-SUMMARY.md`
</output>
