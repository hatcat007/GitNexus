---
phase: 02-resilience
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - gitnexus-mcp/src/mcp/errors.ts
autonomous: true
must_haves:
  truths:
    - "TIMEOUT error includes tool name, timeout duration, and retry guidance"
    - "CIRCUIT_OPEN error includes seconds until retry and actionable message"
    - "CONNECTION_LOST error indicates WebSocket/browser disconnection"
    - "RETRY_EXHAUSTED error indicates max attempts reached"
    - "All resilience errors include retryable boolean and retryAfter seconds"
  artifacts:
    - path: "gitnexus-mcp/src/mcp/errors.ts"
      provides: "Extended error codes for resilience failures"
      contains: "TIMEOUT | CIRCUIT_OPEN | CONNECTION_LOST | RETRY_EXHAUSTED"
      exports: ["timeoutError", "circuitOpenError", "connectionLostError", "retryExhaustedError"]
  key_links:
    - from: "errors.ts"
      to: "resilience.ts"
      via: "error codes used by resilience wrappers"
      pattern: "ErrorCodes\\.(TIMEOUT|CIRCUIT_OPEN)"
---

<objective>
Extend the error module with resilience-specific error codes and formatters.

Purpose: Provide structured error responses for timeout, circuit breaker, and connection failures that help AI agents understand what happened and how to recover.
Output: Extended `gitnexus-mcp/src/mcp/errors.ts` with new error codes and helper functions
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-resilience/02-CONTEXT.md
@.planning/phases/02-resilience/02-RESEARCH.md

# Existing error patterns
@gitnexus-mcp/src/mcp/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add resilience error codes to ErrorCodes</name>
  <files>gitnexus-mcp/src/mcp/errors.ts</files>
  <action>
Extend the `ErrorCodes` object in errors.ts to include resilience-specific codes:

```typescript
export const ErrorCodes = {
    VALIDATION_ERROR: 'VALIDATION_ERROR',
    TOOL_NOT_FOUND: 'TOOL_NOT_FOUND',
    BROWSER_DISCONNECTED: 'BROWSER_DISCONNECTED',
    QUERY_TIMEOUT: 'QUERY_TIMEOUT',
    CYPHER_FORBIDDEN: 'CYPHER_FORBIDDEN',
    INTERNAL_ERROR: 'INTERNAL_ERROR',
    // Resilience error codes (Phase 2)
    TIMEOUT: 'TIMEOUT',
    CIRCUIT_OPEN: 'CIRCUIT_OPEN',
    CONNECTION_LOST: 'CONNECTION_LOST',
    RETRY_EXHAUSTED: 'RETRY_EXHAUSTED',
} as const;
```

The existing `QUERY_TIMEOUT` can be deprecated in favor of the new `TIMEOUT` code, but keep it for backward compatibility.
  </action>
  <verify>grep -E "TIMEOUT|CIRCUIT_OPEN|CONNECTION_LOST|RETRY_EXHAUSTED" gitnexus-mcp/src/mcp/errors.ts | head -10</verify>
  <done>ErrorCodes object contains TIMEOUT, CIRCUIT_OPEN, CONNECTION_LOST, RETRY_EXHAUSTED</done>
</task>

<task type="auto">
  <name>Task 2: Add resilience error helper functions</name>
  <files>gitnexus-mcp/src/mcp/errors.ts</files>
  <action>
Add helper functions for creating resilience errors at the end of errors.ts:

```typescript
/**
 * Creates a timeout error with retry guidance
 */
export function timeoutError(tool: string, timeoutMs: number): GitNexusError {
    const isDebug = process.env.GITNEXUS_DEBUG === 'true';
    return {
        code: ErrorCodes.TIMEOUT,
        message: `Tool '${tool}' exceeded timeout of ${timeoutMs / 1000}s`,
        details: isDebug ? { tool, timeoutMs } : undefined,
        suggestion: 'The operation took too long. Try again with a simpler query or check if the browser is responsive.',
    };
}

/**
 * Creates a circuit breaker open error
 */
export function circuitOpenError(retryAfterSeconds: number = 30): GitNexusError {
    return {
        code: ErrorCodes.CIRCUIT_OPEN,
        message: `Circuit breaker open due to repeated failures. Will retry in ${retryAfterSeconds} seconds.`,
        details: { retryAfter: retryAfterSeconds },
        suggestion: 'Consider checking browser connection or graph status. Wait before retrying.',
    };
}

/**
 * Creates a connection lost error
 */
export function connectionLostError(reason: string = 'WebSocket disconnected'): GitNexusError {
    return {
        code: ErrorCodes.CONNECTION_LOST,
        message: `Connection lost: ${reason}`,
        suggestion: 'Ensure GitNexus is running in your browser. The connection will be retried automatically.',
    };
}

/**
 * Creates a retry exhausted error
 */
export function retryExhaustedError(attempts: number): GitNexusError {
    return {
        code: ErrorCodes.RETRY_EXHAUSTED,
        message: `Maximum reconnection attempts (${attempts}) reached`,
        suggestion: 'Could not reconnect to GitNexus. Please restart the MCP server and ensure GitNexus is running in your browser.',
    };
}
```

All errors should include actionable suggestions. Debug info only included when GITNEXUS_DEBUG=true.
  </action>
  <verify>grep -E "export function (timeoutError|circuitOpenError|connectionLostError|retryExhaustedError)" gitnexus-mcp/src/mcp/errors.ts</verify>
  <done>Four new error helper functions exported: timeoutError, circuitOpenError, connectionLostError, retryExhaustedError</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds without errors
2. ErrorCodes contains 4 new resilience codes
3. All 4 error helper functions exported
4. Each error includes `suggestion` field with actionable guidance
</verification>

<success_criteria>
- errors.ts compiles without TypeScript errors
- All resilience error codes defined
- Helper functions create properly structured GitNexusError objects
- Debug mode conditional works via GITNEXUS_DEBUG env var
</success_criteria>

<output>
After completion, create `.planning/phases/02-resilience/02-02-SUMMARY.md`
</output>
